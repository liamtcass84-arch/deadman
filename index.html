<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deadman Dash 5K</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>

.loginLogo {
  display: block;
  margin: 0 auto 16px auto;
  max-width: 160px;
  width: 100%;
  height: auto;
}

  :root{
    --bg:#0a0a0f;
    --panel:#0f0f14;
    --panel2:#101016;
    --border:#2a2436;
    --text:#ffffff;
    --muted:rgba(255,255,255,.72);
    --accent:#5b2a86;      /* deep purple */
    --danger:#7a1f3d;
    --secondary:#2f2638;
    --green:#7c3aed;       /* purple progress */
  }

  *{ box-sizing:border-box; }
  body { margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--text); }
  section { width:100%; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:16px 0; }

  button { padding:14px 18px; font-size:16px; background:var(--accent); color:white; border:none; border-radius:14px; cursor:pointer; font-weight:900; }
  button:disabled{ opacity:.45; cursor:not-allowed; }
  input { padding:12px; font-size:16px; border-radius:14px; border:1px solid #333; background:var(--panel); color:var(--text); width:100%; }

  .panel { padding:12px; width:92vw; max-width:900px; }
  .leaflet-div-icon { background:transparent !important; border:none !important; }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    font-size:12px; font-weight:800; white-space:nowrap;
  }
  .pillBtn{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    cursor:pointer;
  }

  /* Map */
  #mapWrap{
    width:92vw;
    max-width:900px;
    margin-top:10px;
    position:relative;
  }
  #map {
    height:56vh;
    width:100%;
    border:2px solid var(--accent);
    border-radius:18px;
    overflow:hidden;
    background:#0b0b10;
  }
  /* Helps page scroll when map is locked */
  #map.map-locked{ touch-action: pan-y !important; }
  #map.map-unlocked{ touch-action: none !important; }

  .mapLoading{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(10,10,15,.88);
    border-radius:18px;
    z-index:999;
    padding:14px;
  }
  .mapLoadingCard{
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:14px;
    font-size:13px;
    color:var(--muted);
    width:min(84vw, 420px);
    text-align:center;
  }

  .mapControls{
    position:absolute;
    right:10px;
    bottom:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:1000;
  }
  .mapCtrlBtn{
    background:rgba(15,15,20,0.9);
    border:1px solid var(--border);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-size:13px;
    font-weight:900;
    cursor:pointer;
    backdrop-filter: blur(6px);
  }

  /* Header */
  .topBar{
    width:92vw; max-width:900px;
    margin-top:4px;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .topTitle{ font-size:28px; font-weight:900; letter-spacing:.2px; line-height:1.05; }
  .topSub{ font-size:13px; color:var(--muted); letter-spacing:.2px; }

  .whoRow{
    width:92vw; max-width:900px;
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .helloLine{
    margin-top:8px;
    width:92vw; max-width:900px;
    font-size:16px; font-weight:800; opacity:.95;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .helloPill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
  }

  /* Progress card */
  .progressCard{
    width:92vw; max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
    text-align:left;
  }
  .progressTop{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .progressLabel{ font-size:13px; color:var(--muted); font-weight:700; }
  .progressValue{ font-size:16px; font-weight:900; letter-spacing:.2px; }

  .bar{
    width:100%; height:10px; border-radius:999px;
    background:rgba(255,255,255,0.06);
    border:1px solid var(--border);
    overflow:hidden; margin-top:10px;
  }
  .barFill{
    height:100%; width:0%;
    background:var(--green);
    border-radius:999px;
    transition:width .35s ease;
  }
  .subRow{
    margin-top:10px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .savedPill{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel2);
    font-size:12px;
    opacity:0;
    transform:translateY(-2px);
    transition:opacity .18s ease, transform .18s ease;
  }
  .savedPill.show{ opacity:1; transform:translateY(0px); }
  .completePill{
    display:none;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#0f2a12;
    font-size:12px; font-weight:900;
  }
  .lastUpdate{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
  }
  .nextMoment{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
    font-weight:800;
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px;
    background:var(--panel);
    border:1px solid var(--border);
    padding:10px 12px;
    border-radius:14px;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
    z-index:99999;
    width:min(88vw, 520px);
    text-align:center;
    font-size:14px;
  }
  .toast.show{ opacity:1; }

  /* Controls */
  .controlsCard{
    width:92vw;
    max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
  }
  .btnRow{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:nowrap;
  }
  .quickBtn{
    padding:12px 10px;
    border-radius:16px;
    font-size:16px;
    font-weight:900;
    margin:0;
    flex:1 1 0;
    min-width:0;
    max-width:220px;
    white-space:nowrap;
  }
  .inputRow{
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    margin-top:10px;
    flex-wrap:nowrap;
  }
  .kmInput{
    width:240px;
    max-width:48vw;
    margin:0;
  }
  .addBtn{
    padding:12px 16px;
    margin:0;
    border-radius:16px;
    font-weight:900;
    white-space:nowrap;
  }
  .bottomRow{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    margin-top:10px;
    flex-wrap:nowrap;
  }
  .ghostBtn{
    background:var(--secondary);
    margin:0;
    padding:12px 14px;
    border-radius:16px;
    font-weight:900;
    flex:1 1 0;
    color:var(--text);
  }

  @media (max-width:380px){
    .quickBtn{ font-size:15px; padding:12px 8px; }
    .kmInput{ width:200px; }
  }

  /* Overlays */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.86);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:16px;
  }
  .card{
    width:min(92vw, 720px);
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:16px;
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    text-align:left;
  }

  /* Finish */
  .finishHeaderRow{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:6px;
  }
  .finishConfetti{
    font-size:22px;
    opacity:.95;
    text-align:center;
    letter-spacing:2px;
    animation: pop 1200ms ease-in-out infinite alternate;
  }
  @keyframes pop{
    from{ transform:translateY(0px); opacity:.9; }
    to{ transform:translateY(-3px); opacity:1; }
  }
  .finishTitle{
    font-family: Impact, Haettenschweiler, "Arial Black", sans-serif;
    font-size:44px;
    letter-spacing:1px;
    margin:4px 0 2px;
    text-align:center;
  }
  .finishSub{
    margin:0;
    opacity:.92;
    text-align:center;
    font-size:15px;
    line-height:1.4;
  }
  .finishMeta{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
  }
  .finishHint{
    margin:12px 0 0;
    text-align:center;
    font-size:13px;
    opacity:.75;
  }
  .finishButtons{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .primaryBtn{ background:var(--accent); flex:1 1 220px; }
  .secondaryBtn{ background:var(--secondary); flex:1 1 160px; }

  /* Login */
  .loginCard{
    width:min(92vw, 420px);
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px 16px;
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    text-align:left;
  }
  .loginTitle{ font-size:26px; font-weight:900; margin:0; text-align:center; }
  .loginSub{ margin:8px 0 14px; opacity:.85; font-size:13px; text-align:center; }
  .fieldWrap{ position:relative; width:100%; }
  .pwToggle{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    background:transparent; border:1px solid var(--border);
    color:var(--text); padding:6px 10px; border-radius:10px;
    font-size:12px; cursor:pointer; opacity:.9;
  }
  .warnLine{ margin-top:6px; opacity:.9; font-size:12px; text-align:center; }
  .warnLine b{ color:#ffd1d1; }
  .helpLine{ margin-top:10px; opacity:.75; font-size:12px; text-align:center; }

  /* Splash */
  .splashWrap{
    width:min(92vw, 520px);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .brandStack{
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:center;
    margin-bottom:4px;
  }
  .brandTitle{ font-size:28px; font-weight:900; letter-spacing:.4px; }
  .brandTag{ font-size:14px; opacity:.85; }
  .brandSite{ font-size:12px; opacity:.8; letter-spacing:1px; }

  .welcomeLine{
    font-size:40px;
    font-weight:900;
    margin-top:6px;
    line-height:1.05;
  }
  .nextLine{ font-size:13px; opacity:.8; margin-top:2px; }
  .progressLine{ margin-top:2px; font-size:16px; font-weight:900; opacity:.92; }
  .splashBtn{
    width:min(320px, 78vw);
    padding:16px 18px;
    font-size:18px;
    border-radius:16px;
    margin-top:4px;
  }

  /* Local storage notice */
  .localNotice{
    margin-top:14px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,0.07);
    border:1px solid var(--border);
    font-size:0.85rem;
    line-height:1.45;
    opacity:0.92;
    text-align:left;
  }
  .localNotice strong{
    display:block;
    margin-bottom:6px;
    font-weight:800;
  }
  .localNotice p{ margin:6px 0 0; }

</style>
</head>

<body>
<div id="toast" class="toast"></div>

<!-- LOGIN -->

<section id="auth">
  <div class="loginCard">
  <h1 class="loginTitle">Deadman Dash 5K</h1>
    <div class="loginSub">Log in to track your Deadman Dash 5K progress.</div>

    <div class="fieldWrap">
      <input id="username" placeholder="Username" autocomplete="username" />
    </div>

    <div class="fieldWrap" style="margin-top:6px;">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button class="pwToggle" type="button" onclick="togglePassword()">Show</button>
    </div>

    <div class="warnLine">‚ö†Ô∏è <b>Case sensitive</b> usernames and passwords.</div>

    <button id="loginBtn" onclick="login()" style="width:100%; margin-top:12px;">Login</button>

    <div class="helpLine">Forgot your login? Message the organiser.</div>
  </div>
</section>

<!-- SPLASH -->
<section id="splash" style="display:none">
  <div class="splashWrap">
    <div class="brandStack">
      <div class="brandTitle">Deadman Dash 5K</div>
      <div class="brandTag">walk, run, wrestle</div>
      <div class="brandSite">WRW.COM</div>
    </div>

    <div class="whoRow" style="justify-content:center;">
      <span class="pill">‚úÖ Logged in: <span id="whoSplash" class="mono"></span></span>
      <button class="pillBtn" onclick="logoutConfirm()">Log out</button>
</div>

    <div class="welcomeLine">Welcome <span id="userName"></span></div>
    <div id="splashProgress" class="progressLine">Progress: 0.00 / 5.00 km</div>
    <div class="nextLine">Tap Continue to open the map and log your distance.</div>
    <div class="localNotice">
      <strong>Progress saved on your device</strong>
      <p>This app stores your run progress locally on your phone or browser.</p>
      <p>We don‚Äôt track your activity, build databases, or collect runner data ‚Äî it simply runs on your device to support your run.</p>
      <p>Clearing browser data or switching devices will reset your progress.</p>
      <p>When you finish, submit your proof by email as instructed.</p>
    </div>


    <button id="startBtn" class="splashBtn" onclick="startRun()">Continue</button>
  </div>
</section>

<!-- RUN -->
<section id="run" style="display:none; justify-content:flex-start;">
  <div class="topBar">
    <div class="topTitle">Deadman Dash 5K</div>
    <div class="topSub"></div>
  </div>

  <div class="whoRow">
    <span class="pill">‚úÖ Logged in: <span id="whoRun" class="mono"></span></span>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="pillBtn" onclick="openHelp()">?</button>
<button class="pillBtn" onclick="logoutConfirm()">Log out</button>
    </div>
  </div>

  <div class="helloLine">
    <div class="helloPill">üëã <span id="helloName">Hello</span></div>
  </div>

  <div class="progressCard">
    <div class="progressTop">
      <div class="progressLabel">Progress</div>
      <div class="progressValue"><span id="total">0.00</span> / 5.00 km</div>
    </div>
    <div class="bar"><div id="barFill" class="barFill"></div></div>

    <div class="subRow">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span id="completePill" class="completePill">‚úÖ Completed</span>
        <span id="savedPill" class="savedPill">‚úÖ Saved</span>
      </div>
      <div class="lastUpdate">Last update: <span id="lastUpdateText">‚Äî</span></div>
    </div>

    <div class="nextMoment" id="nextMomentText">Next Deadman moment in: ‚Äî</div>
  </div>

  <div id="mapWrap">
    <div id="map" class="map-locked"></div>

    <div class="mapControls">
      <button class="mapCtrlBtn" id="mapLockBtn" onclick="toggleMapLock()">Unlock map</button>
      <button class="mapCtrlBtn" onclick="fitRoute()">Fit route</button>
      <button class="mapCtrlBtn" onclick="recenter()">Recenter</button>
    </div>

    <div id="mapLoading" class="mapLoading">
      <div class="mapLoadingCard">
        Loading map‚Ä¶ if this takes ages, zoom once (+) and it usually wakes up.
      </div>
    </div>
  </div>

  <div class="controlsCard">
    <div class="btnRow">
      <button class="quickBtn" onclick="requestQuick(0.5, this)">+0.5 km</button>
      <button class="quickBtn" onclick="requestQuick(1, this)">+1 km</button>
      <button class="quickBtn" onclick="requestQuick(2, this)">+2 km</button>
    </div>

    <div class="inputRow">
      <input id="input" class="kmInput" type="text" inputmode="decimal" placeholder="Type km (e.g. 1.5)">
      <button class="addBtn" onclick="requestLogFromInputConfirm(this)">Add</button>
    </div>

    <div class="bottomRow">
      <button id="undoBtn" class="ghostBtn" onclick="undoLast()" disabled>Undo</button>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:center;">
      <button class="pillBtn" onclick="backToTop()">Back to top ‚Üë</button>
    </div>
  </div>

  <div style="height:24px;"></div>
</section>

<!-- FINISH -->
<div class="overlay" id="finishOverlay" role="dialog" aria-modal="true">
  <div class="card">
    <div class="finishHeaderRow"><div class="finishConfetti">üéâ üéä</div></div>
    <div class="finishTitle">WELL DONE!</div>

    <p class="finishSub">
      <b id="finishUser">You</b> completed <b>Deadman Dash 5K</b>
    </p>

    <div class="finishMeta">
      <span class="pill">üèÅ Total: <b id="finishTotal">5.00</b> km</span>
      <span class="pill">üïí Completed: <b id="finishWhen">‚Äî</b></span>
    </div>

    <p class="finishHint">
      <b>Important:</b> to be counted as a finisher (and receive your medal), you <b>must</b> email your proof using the button below.
      This is the <b>only</b> way we can verify your run.
      <br><br>
      Please attach a screenshot or activity proof from your tracker (e.g. Strava/Garmin/Apple/Samsung) showing your <b>distance</b> and <b>date</b> before sending.
    </p>

    <div class="finishButtons">
      <button class="primaryBtn" onclick="emailToWRW()">Send proof</button>
      <button class="secondaryBtn" onclick="closeFinish()">Back to map</button>
    </div>
  </div>
</div>

<!-- HELP -->
<div class="overlay" id="helpOverlay">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div style="font-weight:900; font-size:18px;">Quick help</div>
      <button class="ghostBtn" onclick="closeHelp()">Close</button>
    </div>

    <ul style="margin:10px 0 0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.45;">
      <li>Use the <b>+0.5 / +1 / +2</b> buttons or type your km and tap <b>Add</b>.</li>
      <li>Your progress <b>auto-saves on this device</b>.</li>
      <li><b>Send proof</b> opens an email draft ‚Äî please attach <b>screenshots and/or proof</b> before sending.</li>
      <li><b>Map is locked by default</b> so the page scrolls. Tap <b>Unlock map</b> to move/zoom it.</li>
      <li>Use <b>Fit route</b> / <b>Recenter</b> if the map moves around.</li>
    </ul>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button class="ghostBtn" onclick="fitRoute(); closeHelp();">Fit route</button>
      <button class="ghostBtn" onclick="recenter(); closeHelp();">Recenter</button>
      <button class="ghostBtn" onclick="toggleMapLock();">Toggle lock</button>
    </div>
  </div>
</div>

<script>
/* USERS */
const USERS = {
  "01":"01",
  "02":"02",
  "03":"03",
  "04":"04",
  "05":"05",
  "06":"06",
  "07":"07",
  "08":"08",
  "09":"09",
  "10":"10",
  "11":"11",
  "12":"12",
  "13":"13",
  "14":"14",
  "15":"15",
  "16":"16",
  "17":"17",
  "18":"18",
  "19":"19",
  "20":"20",
  "21":"21",
  "22":"22",
  "23":"23",
  "24":"24",
  "25":"25",
  "26":"26",
  "27":"27",
  "28":"28",
  "29":"29",
  "30":"30",
  "31":"31",
  "32":"32",
  "33":"33",
  "34":"34",
  "35":"35",
  "36":"36",
  "37":"37",
  "38":"38",
  "39":"39",
  "40":"40",
  "41":"41",
  "42":"42",
  "43":"43",
  "44":"44",
  "45":"45",
  "46":"46",
  "47":"47",
  "48":"48",
  "49":"49",
  "50":"50",
  "51":"51",
  "52":"52",
  "53":"53",
  "54":"54",
  "55":"55",
  "56":"56",
  "57":"57",
  "58":"58",
  "59":"59",
  "60":"60",
  "61":"61",
  "62":"62",
  "63":"63",
  "64":"64",
  "65":"65",
  "66":"66",
  "67":"67",
  "68":"68",
  "69":"69",
  "70":"70",
  "71":"71",
  "72":"72",
  "73":"73",
  "74":"74",
  "75":"75",
  "76":"76",
  "77":"77",
  "78":"78",
  "79":"79",
  "80":"80",
  "81":"81",
  "82":"82",
  "83":"83",
  "84":"84",
  "85":"85",
  "86":"86",
  "87":"87",
  "88":"88",
  "89":"89",
  "90":"90",
  "91":"91",
  "92":"92",
  "93":"93",
  "94":"94",
  "95":"95",
  "96":"96",
  "97":"97",
  "98":"98",
  "99":"99"
};
const WRW_EMAIL = "log@walkrunwrestle.com";

/* Run rules */
const CHALLENGE_KM = 5;
const MAP_ROUTE_KM = 25;               // hidden
const TARGET_ROUTE_METERS = MAP_ROUTE_KM * 1000;
const POPUP_DELAY_MS = 5000;

const refs = [
  "1km: The ground shifts. Keep moving.",
  "2km: Deadman pace ‚Äî steady and stubborn.",
  "3km: Halfway. No turning back.",
  "4km: The finish is calling. Don't stop now.",
  "5km: Deadman Dash complete. You survived."
];

function getData(){ return JSON.parse(localStorage.getItem("deadman_users") || "{}"); }
function saveData(d){ localStorage.setItem("deadman_users", JSON.stringify(d)); }
function getUser(){ return sessionStorage.getItem("deadman_user"); }
function getRole(){ return sessionStorage.getItem("deadman_role"); }
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function jsSafe(s){ return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'"); }
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

/* Keep ONLY configured users */
(function setupUsersHardReset(){
  const existing = getData();
  const cleaned = {};

  for (const u in USERS){
    const prev = existing[u] || {};
    cleaned[u] = {
      pass: USERS[u],
      km: (typeof prev.km === "number") ? prev.km : 0,
      history: Array.isArray(prev.history) ? prev.history : [],
      emails: Array.isArray(prev.emails) ? prev.emails : [],
      last_update: (typeof prev.last_update === "string") ? prev.last_update : null,
      finish_at: (typeof prev.finish_at === "string") ? prev.finish_at : null
    };
    if ((cleaned[u].km || 0) >= CHALLENGE_KM && !cleaned[u].finish_at){
      const h = cleaned[u].history;
      cleaned[u].finish_at = h.length ? h[h.length-1].atISO : new Date().toISOString();
    }
    if (!cleaned[u].last_update){
      if (cleaned[u].history.length) cleaned[u].last_update = cleaned[u].history.at(-1).atISO;
      else if (cleaned[u].emails.length) cleaned[u].last_update = cleaned[u].emails.at(-1).atISO;
    }
  }

  saveData(cleaned);
})();

/* Show only one section */
function showOnly(id){
  const ids = ["auth","splash","run"];
  ids.forEach(x => {
    const el = document.getElementById(x);
    if (el) el.style.display = (x === id) ? "flex" : "none";
  });
}

/* Logout confirm */
function logoutConfirm(){
  if (confirm("Log out?")) logout();
}
function logout(){
  teardownMap();
  sessionStorage.removeItem("deadman_role");
  sessionStorage.removeItem("deadman_user");
  sessionStorage.removeItem("");
  location.reload();
}

/* Time helpers */
function displayTime(iso){
  if (!iso) return "‚Äî";
  try { return new Date(iso).toLocaleString(); } catch(e){ return "‚Äî"; }
}
function timeAgo(iso){
  if (!iso) return "‚Äî";
  const t = new Date(iso).getTime();
  if (!isFinite(t)) return "‚Äî";
  const diff = Date.now() - t;
  const s = Math.floor(diff/1000);
  if (s < 10) return "just now";
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s/60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m/60);
  if (h < 48) return `${h}h ago`;
  const d = Math.floor(h/24);
  return `${d}d ago`;
}

/* Toast */
let toastTimer = null;
function showToast(msg, ms=1200){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), ms);
}

/* Saved indicator */
let savedTimer = null;
function flashSaved(){
  const el = document.getElementById("savedPill");
  if (!el) return;
  el.classList.add("show");
  clearTimeout(savedTimer);
  savedTimer = setTimeout(()=>el.classList.remove("show"), 900);
}

/* Completion pill */
let loggingLocked = false;

function isLoggingLocked(){
  return !!loggingLocked;
}

function setLoggingEnabled(enabled){
  loggingLocked = !enabled;

  // Disable/enable log controls
  document.querySelectorAll(".quickBtn, .addBtn").forEach(b => b.disabled = !enabled);
  const input = document.getElementById("input");
  if (input) input.disabled = !enabled;

  // Optional visual cue
  const wrap = document.querySelector(".quickRow");
  if (wrap) wrap.style.opacity = enabled ? "1" : "0.55";
}
function setCompletedUI(isDone){
  const pill = document.getElementById("completePill");
  if (!pill) return;
  pill.style.display = isDone ? "inline-flex" : "none";
}

/* Next moment text */
function updateNextMoment(loggedKm){
  const el = document.getElementById("nextMomentText");
  if (!el) return;

  const km = clamp(Number(loggedKm||0), 0, CHALLENGE_KM);
  if (km >= CHALLENGE_KM){
    el.textContent = "Next Deadman moment in: Completed üèÅ";
    return;
  }
  const nextInt = Math.min(CHALLENGE_KM, Math.floor(km) + 1);
  const remaining = Math.max(0, nextInt - km);
  el.textContent = `Next Deadman moment in: ${remaining.toFixed(2)} km`;
}

/* Progress UI */
function setProgressUI(km){
  const clamped = Math.max(0, Math.min(CHALLENGE_KM, Number(km||0)));
  document.getElementById("total").textContent = clamped.toFixed(2);
  const pct = (clamped / CHALLENGE_KM) * 100;
  document.getElementById("barFill").style.width = pct.toFixed(1) + "%";
  setCompletedUI(clamped >= CHALLENGE_KM);
  setLoggingEnabled(clamped < CHALLENGE_KM);
updateUndoButtonState();
  updateNextMoment(clamped);
}
function updateLastUpdateLabel(){
  const u = getUser();
  const data = getData();
  const iso = data?.[u]?.last_update || null;
  document.getElementById("lastUpdateText").textContent = iso ? displayTime(iso) : "‚Äî";
}
function updateUndoButtonState(){
  const u = getUser();
  const data = getData();
  const hist = data?.[u]?.history;
  const has = Array.isArray(hist) && hist.length > 0;
  const btn = document.getElementById("undoBtn");
  if (btn) btn.disabled = !has;
}

/* show/hide password */
function togglePassword(){
  const pw = document.getElementById("password");
  const btn = document.querySelector(".pwToggle");
  const showing = pw.type === "text";
  pw.type = showing ? "password" : "text";
  btn.textContent = showing ? "Show" : "Hide";
  pw.focus();
}

/* enable login button only when filled */
function updateLoginButton(){
  const u = (document.getElementById("username")?.value || "").trim();
  const p = (document.getElementById("password")?.value || "");
  const btn = document.getElementById("loginBtn");
  if (!btn) return;
  const ready = (u.length && p.length);
  // Some mobile editors/WebViews don't reliably re-enable disabled buttons.
  // So we NEVER hard-disable; we just change opacity to hint.
  btn.disabled = false;
  btn.style.opacity = ready ? "1" : "0.65";
}
document.addEventListener("DOMContentLoaded", function(){
  const u = document.getElementById("username");
  const p = document.getElementById("password");
  // If this file is viewed inside an editor preview that doesn't fire input events reliably,
  // the Login button is still clickable (we removed the disabled attribute in HTML).
  u && u.addEventListener("input", updateLoginButton);
  p && p.addEventListener("input", updateLoginButton);
  u && u.addEventListener("keydown", (e)=>{ if (e.key==="Enter"){ e.preventDefault(); p && p.focus(); }});
  p && p.addEventListener("keydown", (e)=>{ if (e.key==="Enter"){ e.preventDefault(); login(); }});
  updateLoginButton();
});;

/* LOGIN */
function login(){
  const u = (document.getElementById("username")?.value || "").trim();
  const p = (document.getElementById("password")?.value || "");
  if (!u || !p){ alert("Enter username and password."); return; }

  const users = getData();

  if (users[u] && users[u].pass === p){
    teardownMap();
    sessionStorage.setItem("deadman_role","user");
    sessionStorage.setItem("deadman_user",u);
    showOnly("splash");
    document.getElementById("userName").textContent=u;
    document.getElementById("whoSplash").textContent=u;

    const saved = Math.min((users[u].km || 0), CHALLENGE_KM);
    document.getElementById("splashProgress").textContent = `Progress: ${saved.toFixed(2)} / 5.00 km`;
    document.getElementById("startBtn").textContent = saved > 0 ? "Continue" : "Start";
  } else {
    alert("Wrong login (case sensitive).");
  }
}

/* HELP */
function openHelp(){ document.getElementById("helpOverlay").style.display = "flex"; }
function closeHelp(){ document.getElementById("helpOverlay").style.display = "none"; }

/* Back to top */
function backToTop(){ window.scrollTo({ top: 0, behavior: "smooth" }); }

/* =========================
   MAP + ROUTE + PROGRESS
========================= */

/* Snake route in blank region */
const START = [24.65, 12.65];

function haversineMeters(a, b){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const lat1 = toRad(a[0]), lat2 = toRad(b[0]);
  const dLat = toRad(b[0]-a[0]);
  const dLng = toRad(b[1]-a[1]);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const x = s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(x)));
}
function totalRouteMeters(route){
  let m = 0;
  for (let i=1;i<route.length;i++) m += haversineMeters(route[i-1], route[i]);
  return m;
}
function generateDeadmanRouteBase(){
  /*
    DEADMAN DASH 5K ‚Äì "Gravestone" route (no overlaps)
    - Start at Point A (near START)
    - Up left side
    - Rounded top (semi-circle)
    - Down right side
    - Back along the bottom and finish close to Point A (but not on it)
    NOTE: This base shape is later scaled to TARGET_ROUTE_METERS by scaleRouteToMeters().
  */

  const base = START; // [lat, lng]

  // Shape in abstract units (will be scaled later)
  const w = 1.0;         // width
  const h = 1.7;         // height
  const r = 0.5;         // top radius
  const gap = 0.18;      // how close the finish gets back to the start along the bottom

  // Convert abstract units to lat/lng deltas (arbitrary; scaling happens later)
  const unitLat = 0.02;
  const unitLng = 0.02;

  const pts = [];

  // Start at bottom-left
  const start = [-w/2, -h/2];
  pts.push([base[0] + start[1]*unitLat, base[1] + start[0]*unitLng]); // (x->lng, y->lat)

  // Up left side to start of the rounded top
  const leftTop = [-w/2, h/2 - r];
  pts.push([base[0] + leftTop[1]*unitLat, base[1] + leftTop[0]*unitLng]);

  // Rounded top: semi-circle from left to right
  const cx = 0.0;
  const cy = h/2 - r;
  const steps = 24;
  for (let i=0; i<=steps; i++){
    const t = Math.PI - (Math.PI * i/steps); // pi -> 0
    const x = cx + r * Math.cos(t);
    const y = cy + r * Math.sin(t);
    pts.push([base[0] + y*unitLat, base[1] + x*unitLng]);
  }

  // Down right side to bottom-right
  const rightBottom = [w/2, -h/2];
  pts.push([base[0] + rightBottom[1]*unitLat, base[1] + rightBottom[0]*unitLng]);

  // Along the bottom back toward the start, but stop short (finish close to Point A)
  const finish = [-w/2 + (w*gap), -h/2];
  pts.push([base[0] + finish[1]*unitLat, base[1] + finish[0]*unitLng]);

  return pts;
}
function scaleRouteToMeters(route, targetMeters){
  const current = totalRouteMeters(route);
  if (!current || current < 1) return route;
  const scale = targetMeters / current;
  return route.map(pt => {
    const dLat = pt[0] - START[0];
    const dLng = pt[1] - START[1];
    return [START[0] + dLat * scale, START[1] + dLng * scale];
  });
}
const ROUTE = scaleRouteToMeters(generateDeadmanRouteBase(), TARGET_ROUTE_METERS);

/* MAP STATE */
let map, redLine, greenLine, progressDot;
let distCum = [], totalMeters = 0;
let popped = new Set();
let lastLoggedDistance = null;

/* Map lock state */
let mapLocked = true;

/* Clean teardown so switching pages is safe */
function teardownMap(){
  try{
    if (map){
      map.off();
      map.remove();
    }
  }catch(e){}
  map = null;
  redLine = null;
  greenLine = null;
  progressDot = null;
  distCum = [];
  totalMeters = 0;
  popped = new Set();
  lastLoggedDistance = null;
  mapLocked = true;
}

/* Map lock/unlock */
function applyMapLockState(){
  if (!map) return;
  const mapEl = document.getElementById("map");

  if (mapLocked){
    map.scrollWheelZoom.disable();
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    if (map.tap) map.tap.disable();

    document.getElementById("mapLockBtn").textContent = "Unlock map";
    mapEl.classList.add("map-locked");
    mapEl.classList.remove("map-unlocked");
  } else {
    map.scrollWheelZoom.enable();
    map.dragging.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    if (map.tap) map.tap.enable();

    document.getElementById("mapLockBtn").textContent = "Lock map";
    mapEl.classList.remove("map-locked");
    mapEl.classList.add("map-unlocked");
  }
}
function toggleMapLock(){
  mapLocked = !mapLocked;
  applyMapLockState();
  showToast(mapLocked ? "Map locked üîí (scroll page normally)" : "Map unlocked üó∫Ô∏è (move/zoom)", 1200);
}

/* START RUN */
function startRun(){
  const u = getUser() || "";
  showOnly("run");

  document.getElementById("helloName").textContent = `Hello ${u}`;
  document.getElementById("whoRun").textContent = u;

  teardownMap();
  map = L.map("map", { zoomControl: true }).setView(START, 9);

  // Locked by default (better scrolling)
  mapLocked = true;
  applyMapLockState();

  const tiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png", {
    maxZoom: 19, subdomains: "abcd",
    attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
  }).addTo(map);

  const loadingEl = document.getElementById("mapLoading");
  let hideDone = false;
  function hideLoading(){
    if (hideDone) return;
    hideDone = true;
    loadingEl.style.display = "none";
  }
  tiles.once("load", hideLoading);
  setTimeout(hideLoading, 3500);

  redLine = L.polyline(ROUTE, { color: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(), weight:4, opacity:0.90 }).addTo(map);
  greenLine = L.polyline([], { color: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(), weight:6, opacity:0.95 }).addTo(map);

  // Subtle pulsing progress dot (small + NO SCALE)
  progressDot = L.circleMarker(ROUTE[0], {
    radius: 4,
    weight: 2,
    color: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
    fillColor: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
    fillOpacity: 0.9,
    className: "pulse-dot"
  }).addTo(map);

  fitRoute();

  distCum = [0];
  totalMeters = 0;
  for (let i=1;i<ROUTE.length;i++){
    totalMeters += map.distance(ROUTE[i-1], ROUTE[i]);
    distCum.push(totalMeters);
  }

  const data = getData();
  const saved = Math.min((data[u]?.km || 0), CHALLENGE_KM);
  setProgressUI(saved);
  setProgressInstant(saved);
  updateLastUpdateLabel();

  if (saved >= CHALLENGE_KM){
    if (!data[u].finish_at) {
      data[u].finish_at = new Date().toISOString();
      data[u].last_update = data[u].finish_at;
      saveData(data);
      updateLastUpdateLabel();
    }
    showFinish();
  }
}

/* Map controls */
function recenter(){
  if (!map) return;
  map.setView(START, 9, { animate:true });
}
function fitRoute(){
  if (!map || !redLine) return;
  map.fitBounds(redLine.getBounds(), { padding:[26,26] });
}

/* PROGRESS helpers */
function metersForLoggedKm(loggedKm){
  const clamped = Math.max(0, Math.min(CHALLENGE_KM, loggedKm));
  return (clamped / CHALLENGE_KM) * totalMeters;
}
function pointAtMeters(m){
  if (m <= 0) return { pt: ROUTE[0], idx: 0 };
  if (m >= totalMeters) return { pt: ROUTE[ROUTE.length-1], idx: ROUTE.length-2 };

  let i=0;
  while (i < distCum.length-1 && distCum[i+1] < m) i++;

  const A = ROUTE[i], B = ROUTE[i+1];
  const t = (m - distCum[i]) / (distCum[i+1] - distCum[i]);
  return { pt: [A[0] + (B[0]-A[0])*t, A[1] + (B[1]-A[1])*t], idx: i };
}
function polyUpToMeters(m){
  const { pt, idx } = pointAtMeters(m);
  const base = ROUTE.slice(0, idx+1);
  base.push(pt);
  return base;
}
function setProgressInstant(loggedKm){
  if (!map || !greenLine || !progressDot) return;
  const m = metersForLoggedKm(loggedKm);
  const { pt } = pointAtMeters(m);
  greenLine.setLatLngs(polyUpToMeters(m));
  progressDot.setLatLng(pt);
}
function animateProgress(fromLoggedKm, toLoggedKm){
  const fromM = metersForLoggedKm(fromLoggedKm);
  const toM   = metersForLoggedKm(toLoggedKm);

  const frames = 170;
  let f = 0;

  function step(){
    f++;
    const t = Math.min(1, f/frames);
    const m = fromM + (toM - fromM) * t;

    const { pt } = pointAtMeters(m);
    greenLine.setLatLngs(polyUpToMeters(m));
    progressDot.setLatLng(pt);

    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* CONFIRM POPUP */

/* QUICK LOG (no confirmation) */
function requestQuick(km, btn){
  // Lock logging once completed
  if (isLoggingLocked()) return;

  km = Number(km);
  if (!km || km <= 0) return;

  // Prevent accidental double-taps
  if (btn && btn.dataset && btn.dataset.busy === "1") return;
  if (btn && btn.dataset) btn.dataset.busy = "1";

  // Button feedback
  const oldText = btn ? btn.textContent : "";
  if (btn){
    btn.disabled = true;
    btn.textContent = "Saved ‚úì";
  }

  doLog(km);

  // Restore button after a short moment
  if (btn){
    setTimeout(()=>{
      btn.disabled = false;
      btn.textContent = oldText;
      btn.dataset.busy = "0";
    }, 700);
  }
}
function confirmAddKm(km){
  return confirm(`You are adding +${Number(km).toFixed(2)} km.\n\nPress OK to confirm.`);

/* Backwards compatibility: if anything still calls requestLog, treat it as quick (no confirm) */
function requestLog(km){ return requestQuick(km); }

}

/* LOG */
function requestLogWithConfirm(km){
  km = Number(km);
  if (!km || km <= 0) return;
  if (!confirmAddKm(km)) return;
  doLog(km);
}
function parseKmInput(raw){
  if (raw == null) return NaN;
  const s = String(raw).trim().replace(",", ".");
  if (!s) return NaN;
  return Number(s);
}
function requestLogFromInputConfirm(btn){
  // Lock logging once completed
  if (isLoggingLocked()) return;

  // Prevent accidental double-taps on the Add button
  if (btn && btn.dataset && btn.dataset.busy === "1") return;
  if (btn && btn.dataset) btn.dataset.busy = "1";

  const v = parseKmInput(document.getElementById("input").value);
  if (!v || v <= 0) return;
  requestLogWithConfirm(v);
  if (btn && btn.dataset) setTimeout(()=>{ btn.dataset.busy = "0"; }, 900);
}

/* UNDO */
function undoLast(){
  const u = getUser();
  const data = getData();
  if (!data[u]) return;

  const hist = Array.isArray(data[u].history) ? data[u].history : [];
  if (!hist.length){
    showToast("Nothing to undo.", 1200);
    updateUndoButtonState();
    return;
  }

  const last = hist.at(-1);
  const lastKm = Number(last.km || 0);

  if (!confirm(`Undo last log (${lastKm.toFixed(2)} km)?`)) return;

  const before = Math.min(Number(data[u].km || 0), CHALLENGE_KM);
  const after  = clamp(before - lastKm, 0, CHALLENGE_KM);

  hist.pop();
  data[u].history = hist;
  data[u].km = after;

  if (after < CHALLENGE_KM) data[u].finish_at = null;

  data[u].last_update = new Date().toISOString();
  saveData(data);

  lastLoggedDistance = null;

  setProgressUI(after);
  setProgressInstant(after);
  updateLastUpdateLabel();

  popped = new Set();
  closeFinish();

  showToast(`Undone (-${lastKm.toFixed(2)} km)`, 1200);
  updateUndoButtonState();
}

/* LOG */
function doLog(addKm){
  const data = getData();
  const u = getUser();
  if (!data[u]) return alert("User not found.");

  const before = Math.min(Number(data[u].km || 0), CHALLENGE_KM);
  const after  = Math.min(before + addKm, CHALLENGE_KM);

  data[u].km = after;

  data[u].history = Array.isArray(data[u].history) ? data[u].history : [];
  const nowISO = new Date().toISOString();
  const nowLocal = new Date().toLocaleString();
  data[u].history.push({ atISO: nowISO, atLocal: nowLocal, km: addKm });

  data[u].last_update = nowISO;

  if (after >= CHALLENGE_KM && !data[u].finish_at){
    data[u].finish_at = nowISO;
  }

  saveData(data);
  lastLoggedDistance = addKm;

  setProgressUI(after);
  animateProgress(before, after);

  flashSaved();
  updateLastUpdateLabel();

  showToast(`Added +${addKm.toFixed(2)} km`, 1100);

  document.getElementById("input").value = "";
  updateUndoButtonState();

  for (let k = Math.floor(before)+1; k <= Math.floor(after); k++){
    if (k < 1 || k > CHALLENGE_KM) continue;
    if (popped.has(k)) continue;
    popped.add(k);

    setTimeout(() => {
      const m = metersForLoggedKm(k);
      const { pt } = pointAtMeters(m);
      L.popup({ closeButton:true, autoClose:true })
        .setLatLng(pt)
        .setContent(refs[k-1])
        .openOn(map);
    }, POPUP_DELAY_MS);
  }

  if (after >= CHALLENGE_KM){
    setTimeout(()=>showFinish(), 450);
  }
}

/* EMAIL */
function recordEmailAttempt(user){
  const data = getData();
  if (!data[user]) return;
  data[user].emails = Array.isArray(data[user].emails) ? data[user].emails : [];
  const nowISO = new Date().toISOString();
  const nowLocal = new Date().toLocaleString();
  data[user].emails.push({ atISO: nowISO, atLocal: nowLocal });
  data[user].last_update = nowISO;
  saveData(data);
  updateLastUpdateLabel();
}
function emailToWRW(){
  const u = getUser() || "unknown";
  const logged = (typeof lastLoggedDistance === "number") ? Number(lastLoggedDistance).toFixed(2) : "N/A";

  const subject = `Deadman Dash 5K - ${u}`;
  const body = [
    `User: ${u}`,
    `Distance logged: ${logged} km`,
    "",
    "Please attach screenshots and/or proof to this email before sending."
  ].join("\n");

  recordEmailAttempt(u);

  const mailto =
    `mailto:${encodeURIComponent(WRW_EMAIL)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  // This will switch apps; when you return, we force Leaflet to redraw (see visibility/focus handlers).
  window.location.href = mailto;
}

/* FINISH */
function showFinish(){
  const u = getUser() || "You";
  const data = getData();
  const obj = data[u] || {};
  const total = Math.min(Number(obj.km || 0), CHALLENGE_KM).toFixed(2);
  const whenISO = obj.finish_at || new Date().toISOString();
  const whenNice = (function(){
    try { return new Date(whenISO).toLocaleString(); } catch(e){ return "‚Äî"; }
  })();

  document.getElementById("finishUser").textContent = u;
  document.getElementById("finishTotal").textContent = total;
  document.getElementById("finishWhen").textContent = whenNice;

  document.getElementById("finishOverlay").style.display = "flex";
}
function closeFinish(){ document.getElementById("finishOverlay").style.display = "none"; }

/* ===== Map comes back after leaving to email ===== */
function refreshMapAfterReturn(){
  if (!map) return;
  try{
    map.invalidateSize(true);
    // keep it tidy: if user comes back and it looks blank, fit once
    if (redLine) map.fitBounds(redLine.getBounds(), { padding:[26,26] });
  }catch(e){}
}
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible"){
    setTimeout(refreshMapAfterReturn, 120);
    setTimeout(refreshMapAfterReturn, 420);
  }
});
window.addEventListener("focus", ()=>{
  setTimeout(refreshMapAfterReturn, 120);
});
window.addEventListener("pageshow", ()=>{
  setTimeout(refreshMapAfterReturn, 120);
});

/* Splash -> Run */
showOnly("auth");
</script>
</body>
</html>